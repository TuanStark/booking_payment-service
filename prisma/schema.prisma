generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PaymentMethod {
  VIETQR
  VNPAY
  ZALOPAY
  MOMO
  PAYOS
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
  CANCELLED
}

model Payment {
  id            String        @id @default(uuid())
  userId        String        @map("user_id")
  bookingId     String        @map("booking_id")
  amount        Float
  method        PaymentMethod
  qrImageUrl    String?       @map("qr_image_url") // QR cho VietQR/ZaloPay/MoMo/PayOs nếu cần
  paymentUrl    String?       @map("payment_url") // Redirect URL cho VNPay/MoMo/ZaloPay/PayOs
  transactionId String?       @map("transaction_id") // Generic: transId (MoMo), txnRef (VNPay), appTransId (PayOs), orderCode (ZaloPay)
  orderCode     BigInt?       @map("order_code") // PayOS required numeric order code
  reference     String?
  status        PaymentStatus @default(PENDING)
  paymentDate   DateTime?     @map("payment_date") // Thời gian success từ IPN/callback
  providerData  Json?         @map("provider_data") // JSONB: Lưu data specific (e.g. { "transId": "123", "payType": "qr", "token": "aesToken" })

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  details PaymentDetails?

  @@index([bookingId])
  @@index([userId])
  @@index([status])
  @@index([method])
  @@map("payments")
}

// Model RIÊNG cho data chi tiết (nếu cần recurring/subscription hoặc refund log)
model PaymentDetails {
  id        String  @id @default(uuid())
  paymentId String  @unique @map("payment_id")
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  // Fields cho recurring (MoMo/ZaloPay/PayOs hỗ trợ tokenization, VNPay thì ít hơn)
  recurringToken String?   @map("recurring_token") // Token cho auto-charge (encrypt trước khi save)
  frequency      String?   @map("frequency") // MONTHLY/YEARLY (nếu subscription)
  nextChargeDate DateTime? @map("next_charge_date")
  subsPlanId     String?   @map("subs_plan_id") // e.g. 'premium_monthly'

  // Refund info (chung cho tất cả provider)
  refundAmount Float?    @map("refund_amount")
  refundDate   DateTime? @map("refund_date")
  refundReason String?   @map("refund_reason")

  // Extra metadata (JSON nếu cần mở rộng)
  extraMetadata Json? @map("extra_metadata")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([paymentId])
  @@map("payment_details")
}
